<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <style>
        body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #F5F7FA;
            position: relative;
        }

        .iframe-container {
            position: absolute;
            top: 60px;
            bottom: 42px;
            width: 100%;
            max-width: 1600px;
            background-color: #F5F7FA;
        }

        iframe {
            width: 100%;
            height: calc(100vh - 96px);
            border: none;
        }

        header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #2A81F9;
        }

        footer {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 42px;
            background-color: #2A81F9;
        }

        @media (max-width: 1023px) {
            header {
                height: 0px;
            }

            footer {
                height: 0px;
            }

            iframe {
                height: 100vh;
            }

            .iframe-container {
                top: 0;
                bottom: 0;
            }
        }
    </style>
</head>

<body>
    <script>
        // Push a state to history when page loads
        history.pushState(null, null, location.href);

        // Listen for back button
        window.addEventListener('popstate', function (event) {
            // Show confirmation alert
            const confirmLeave = confirm('Handle back hardware trigger "BACK"?');

            if (confirmLeave) {
                // If user confirms, allow navigation
                history.back();
            } else {
                // If user cancels, push state again to prevent navigation
                history.pushState(null, null, location.href);
            }
        });
    </script>
    <header></header>

    <div class="iframe-container" id="app-iframe">
        <iframe src="/index.html" title="Centered Iframe"></iframe>
    </div>
    <footer class="bottom-footer"></footer>
    <script>
        document.addEventListener("DOMContentLoaded", function (event) {
            // Gửi params vào iframe qua postMessage
            function sendParamsToIframe(params) {
                // Lấy iframe element từ container
                const iframeContainer = document.getElementById('app-iframe');
                const iframe = iframeContainer.querySelector('iframe');
                // Gửi message vào iframe
                iframe.contentWindow.postMessage(params, '*');
            }

            const screenData = localStorage.getItem('SAMPLE_SCREEN_DATA');
            console.log('screenData ======= ', screenData);
            // Screen data giờ là string (format: action/param hoặc action)
            let screen = null;
            if (screenData && screenData.trim()) {
                screen = screenData.trim();
            }

            // Lấy token từ localStorage (là JSON string)
            const tokenString = localStorage.getItem('SAMPLE_TOKEN');
            console.log('tokenString ======= ', tokenString);

            const params = {
                action: 'WEB_TO_SDK', params: {
                    token: tokenString, // Truyền toàn bộ JSON string vào token
                    lang: localStorage.getItem('SAMPLE_LANGUAGE') || 'vi',
                    ...(screen && { screen: screen })
                }
            };

            // Lấy iframe element để dùng trong các handlers
            const iframeContainer = document.getElementById('app-iframe');
            const iframe = iframeContainer ? iframeContainer.querySelector('iframe') : null;

            // // Helper function để ghi log
            // function logSecureAction(action, key, value, error = null) {
            //     debugger;   
            //     try {
            //         const logData = {
            //             action: action,
            //             key: key,
            //             timestamp: new Date().toISOString(),
            //             url: window.location.href,
            //             userAgent: navigator.userAgent,
            //             ...(value && { hasValue: true, valueLength: String(value).length }),
            //             ...(error && { error: error.message || String(error) })
            //         };
                    
            //         console.log(`[${action}]`, logData);
                    
            //         // Gửi log về iframe để iframe có thể ghi log chính thức
            //         if (iframe && iframe.contentWindow) {
            //             iframe.contentWindow.postMessage({
            //                 action: 'LOG_SECURE_ACTION',
            //                 logData: logData
            //             }, '*');
            //         }
            //     } catch (logError) {
            //         console.error('Failed to log secure action:', logError);
            //     }
            // }

            // Lắng nghe message từ iframe (nếu cần callback)
            window.addEventListener('message', function (event) {
                console.log('event?.data ======= ', event?.data);
                if (event?.data?.action === 'WEB_READY') {
                    sendParamsToIframe(params);
                }

                if (event?.data?.action === 'SAVE_SECURE') {
                    try {
                        const { callbackId } = event.data || {};
                        const { key, value } = event.data.data || {};
                        
                        if (!key) {
                            throw new Error('Key is required for SAVE_SECURE');
                        }
                        
                        // Lưu vào localStorage với prefix để dễ quản lý
                        const storageKey = `SECURE_${key}`;
                        localStorage.setItem(storageKey, value || '');
                        
                        // // Ghi log
                        // logSecureAction('SAVE_SECURE', key, value);
                        
                        // Trả response về iframe
                        if (iframe && iframe.contentWindow && callbackId) {
                            iframe.contentWindow.postMessage({
                                success: true,
                                callbackId: callbackId,
                                data: null
                            }, '*');
                        }
                    } catch (error) {
                        console.error('SAVE_SECURE error:', error);
                        // logSecureAction('SAVE_SECURE', event?.data?.data?.key, null, error);
                        
                        // Trả error về iframe
                        if (iframe && iframe.contentWindow && event?.data?.callbackId) {
                            iframe.contentWindow.postMessage({
                                success: false,
                                callbackId: event.data.callbackId,
                                error: error.message || 'Failed to save secure data'
                            }, '*');
                        }
                    }
                }
                
                if (event?.data?.action === 'GET_SECURE') {
                    // debugger;
                    try {
                        const { callbackId } = event.data || {};
                        const { key } = event.data.data || {};
                        
                        if (!key) {
                            throw new Error('Key is required for GET_SECURE');
                        }
                        
                        // Lấy từ localStorage
                        const storageKey = `SECURE_${key}`;
                        const value = localStorage.getItem(storageKey);
                        
                        // // Ghi log
                        // logSecureAction('GET_SECURE', key, value);
                        
                        // Trả response về iframe
                        if (iframe && iframe.contentWindow && callbackId) {
                            iframe.contentWindow.postMessage({
                                success: true,
                                callbackId: callbackId,
                                data: value // Trả về value hoặc null nếu không tìm thấy
                            }, '*');
                        }
                    } catch (error) {
                        console.error('GET_SECURE error:', error);
                        // logSecureAction('GET_SECURE', event?.data?.data?.key, null, error);
                        
                        // Trả error về iframe
                        if (iframe && iframe.contentWindow && event?.data?.callbackId) {
                            iframe.contentWindow.postMessage({
                                success: false,
                                callbackId: event.data.callbackId,
                                error: error.message || 'Failed to get secure data'
                            }, '*');
                        }
                    }
                }
                
                if (event?.data?.action === 'DELETE_SECURE') {
                    try {
                        const { callbackId } = event.data || {};
                        const { key, value } = event.data.data || {};
                        
                        if (!key) {
                            throw new Error('Key is required for DELETE_SECURE');
                        }
                        
                        // Xóa khỏi localStorage
                        const storageKey = `SECURE_${key}`;
                        const existed = localStorage.getItem(storageKey) !== null;
                        localStorage.removeItem(storageKey);
                        
                        // // Ghi log
                        // logSecureAction('DELETE_SECURE', key, null);
                        
                        // Trả response về iframe
                        if (iframe && iframe.contentWindow && callbackId) {
                            iframe.contentWindow.postMessage({
                                success: true,
                                callbackId: callbackId,
                                data: null
                            }, '*');
                        }
                    } catch (error) {
                        console.error('DELETE_SECURE error:', error);
                        // logSecureAction('DELETE_SECURE', event?.data?.data?.key, null, error);
                        
                        // Trả error về iframe
                        if (iframe && iframe.contentWindow && event?.data?.callbackId) {
                            iframe.contentWindow.postMessage({
                                success: false,
                                callbackId: event.data.callbackId,
                                error: error.message || 'Failed to delete secure data'
                            }, '*');
                        }
                    }
                }
                if (event?.data?.action === 'UNKNOWN_ERROR') {
                    console.log('event?.data?.error ======= ', event?.data?.error);
                }
                if (event?.data?.action === 'BACK_APP') {
                    window.open('/sample.html', '_self');
                }
            });
        });
    </script>
</body>

</html>