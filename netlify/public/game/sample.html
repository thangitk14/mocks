<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game SDK - Get Token</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        select {
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
            font-size: 12px;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #openSdkBtn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }

        .result.show {
            display: block;
        }

        .result h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result pre {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e0e0e0;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
        }

        .success {
            background: #efe;
            border: 1px solid #cfc;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #856404;
        }

        .loading {
            text-align: center;
            color: #667eea;
            margin-top: 10px;
            display: none;
        }

        .loading.show {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîê Game SDK Token 1.0.4</h1>
        <p class="subtitle">Nh·∫≠p th√¥ng tin ƒë·ªÉ l·∫•y token t·ª´ Loyalty SDK</p>

        <div class="warning">
            ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> Private key ƒë√£ ƒë∆∞·ª£c hard code trong JavaScript. ƒê√¢y ch·ªâ l√† demo, trong
            production n√™n x·ª≠ l√Ω ·ªü server-side.
        </div>

        <form id="tokenForm">
            <div class="form-group">
                <label for="cif">M√£ CIF:</label>
                <input type="text" value="998877666" id="cif" placeholder="Nh·∫≠p m√£ CIF (VD: 123456789)" required>
            </div>

            <div class="form-group">
                <label for="baseUrl">Base URL:</label>
                <input type="text" id="baseUrl" value="https://fw.thangvnnc.io.vn/fmvgame" placeholder="Nh·∫≠p Base URL (VD: https://vbb-web-sdk-loyaltyos.akachains.io)">
            </div>

            <div class="form-group">
                <label for="screenSelect">Ch·ªçn m√†n h√¨nh:</label>
                <select id="screenSelect">
                    <option value="">Trang ch·ªß</option>
                    <option value="pointHistoryDetail/63b13701-04d5-292a-099b-3a1d895c94e9">Chi ti·∫øt t√≠ch ti√™u ƒëi·ªÉm</option>
                    <option value="rankAndBenefits">Thay ƒë·ªïi h·∫°ng</option>
                    <option value="pointHistory/PointReceived">Danh s√°ch l·ªãch s·ª≠ ƒëi·ªÉm</option>
                </select>
            </div>

            <div class="form-group">
                <label for="languageSelect">Ch·ªçn ng√¥n ng·ªØ:</label>
                <select id="languageSelect">
                    <option value="vi">Ti·∫øng Vi·ªát</option>
                    <option value="en">English</option>
                </select>
            </div>

            <div class="form-group">
                <label for="screenData">Screen data:</label>
                <textarea id="screenData" placeholder=''></textarea>
            </div>

            <div class="button-group">
                <button type="button" id="getTokenBtn">L·∫•y Token</button>
                <button type="button" id="openSdkBtn">M·ªü SDK</button>
            </div>
        </form>

        <div class="loading" id="loading">
            <p>‚è≥ ƒêang x·ª≠ l√Ω...</p>
        </div>

        <div class="result" id="result">
            <h3 id="resultTitle">K·∫øt qu·∫£</h3>
            <pre id="resultContent"></pre>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.8.6/jsrsasign-all-min.js"></script>

    <script>
        // Hard code private key
        const PRIVATE_KEY = `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDID0ECd2dV3+Le
vtUOBbJkfUBhS+HlFyvlwdiedq2TWK9eUlxXQ0+X4/FxJ4zJrCsWoUQXSva768oM
Gsa+m3VD9Gd4Jkwcq3Snb0WonYn+decw92aK6jjKDyYtxSFwNcNAlPnlM+LK6ME8
RidNNpUskhK6OvqShXpFFdjR2qgAaPxAf9l9HDGRIAvrAV1DTH3tGH4xhS0pF0PC
KLSAvjZcB/1VacoLZJGA1X12iQLWbBpzzoDZLkCch4Mo3v6mjUDPJIxTqk1ydjHZ
Nh3R6aXxy4YKhNsTsTh0E5kDcjI7/dN8+zn0ch5w5rpSntXNyu2iKwG3dv2AKr6P
FHNLe+lRAgMBAAECggEAWHx+uZOMjiwPkYwAekpExDOuFRrWGFjuXpolsLk3PtPc
BTESjLpF6x2z/eOLXuwaxtCfaFoM1cONw1rYixgBfwQL+9WclpWzbBdITTMZBQar
MjpLDahZY+3daiMmDhaJfPgnq5wOdMcMKReybHF2+5bEV8CccdA9626lTvSSmFMO
QKhM5Tzcc+OSvNLVlxGnecxC5J/STXzsFfTMmbj+Zsdf/qNy2O2rAmPSL6gHv6Zs
RCMIcGXxASC+bxwBDrfyFCTT8w0Z9gBB+RztgbhbDfMpQo8CvrP9uDJ0iTADbyiX
E04i5bo6S8EgM9LEea22fh9/2CENCBXJOIvxL00cDQKBgQD3CiGKqbvJqqo/+gL4
X/aN+numMc7Ruf5T0BDzLvYnywjIcg5mZuwvJSb1QXdtBmMEAKeKXozXmK7v4RiP
EA5YLQW2KXk8eiPdAW1ZWlkcmcz0SGOReGCjFSyfZXSctqkfwrboBxfreIjttgwy
cN4wrar61YqrwBn3AxEBn1NphwKBgQDPUOS6XNd7/EGUOn5eTPDvV9na03N+gphx
K3+007k8iV5QxOkmHlvS080ViMfvdKUo1QeSBnT+KVsVOqFDL3C+pbc5XJ6NBFkm
TCHEK32qXLemc/61l6/13xBn/PXMSKGmNRpcDJ+tObUQa7DCiM6adeQh+yEYYRxB
/k0Q8DzsZwKBgAUPAgzS2POSORZCSllHrcbOgEWw82k8A8c3lYFFTukVsUJZg435
QZDdk+SlyIpE/TYRxVyB/yRTDhH/a/9R9tk7YsiOJNtmLOHTq6eOwBBj3dyKtu89
pczxHA7PhwnGe8QYuqIZsxWxTCyB89H8mbApfjzQrpxBvMZgG7MKzix1AoGBAIlE
VX3ztRW56636oOtNZIYFFBEoyqLsU4UzOQaA3XhwuAsgpgMAPOo2JOdqPn+VKzoC
+1U7g0E6Hr3KqTXz9mG1FcEcSzqxs1mBNSZPaZBgfZTv3qlb+zz/6jwAKLuPJ8EG
DiL+lMc8m194/nt/29Q31MqPHdWnju8/MsXRW3VnAoGAMRm8V99/r1pJKPJqSi6E
p258mCwgOIPZMXTag2ki/BeunSanawTVjXgua+Bib/JBtS8gyMlzaC/f2RgnKO8q
0dbRWE1QAnmGx0hmSZDFJWEeD7/18IUfd7hssMNVIKJiL7ga1al92BqwhY+JQOTx
eOpd4wnjY3Aa7MaAcpQ4QqM=
-----END PRIVATE KEY-----`;

        // Load saved screen data and language from localStorage when page loads
        function loadSavedScreenData() {
            const savedScreenData = localStorage.getItem('SAMPLE_SCREEN_DATA');
            const savedLanguage = localStorage.getItem('SAMPLE_LANGUAGE');
            const savedBaseUrl = localStorage.getItem('SAMPLE_BASE_URL');
            const screenDataTextarea = document.getElementById('screenData');
            const screenSelect = document.getElementById('screenSelect');
            const languageSelect = document.getElementById('languageSelect');
            const baseUrlInput = document.getElementById('baseUrl');

            // Load baseUrl
            if (savedBaseUrl && baseUrlInput) {
                baseUrlInput.value = savedBaseUrl;
            }

            // Load language
            if (savedLanguage && languageSelect) {
                languageSelect.value = savedLanguage;
            } else if (languageSelect) {
                // Default to Vietnamese
                languageSelect.value = 'vi';
            }

            // M·∫∑c ƒë·ªãnh lu√¥n l√† "Trang ch·ªß" v√† screen data empty
            if (screenDataTextarea) {
                screenDataTextarea.value = '';
            }
            if (screenSelect) {
                screenSelect.selectedIndex = 0; // "Trang ch·ªß"
            }
        }

        // Handle dropdown change
        function initScreenSelect() {
            const screenSelect = document.getElementById('screenSelect');
            if (screenSelect) {
                screenSelect.addEventListener('change', function (e) {
                    const selectedValue = e.target.value;
                    const screenDataTextarea = document.getElementById('screenData');
                    if (screenDataTextarea) {
                        // N·∫øu ch·ªçn "Trang ch·ªß" (value r·ªóng), clear screen data
                        if (!selectedValue || selectedValue.trim() === '') {
                            screenDataTextarea.value = '';
                        } else {
                            // Set gi√° tr·ªã string tr·ª±c ti·∫øp (kh√¥ng c·∫ßn JSON)
                            screenDataTextarea.value = selectedValue;
                        }
                    }
                });
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                loadSavedScreenData();
                initScreenSelect();
                initButtons();
            });
        } else {
            // DOM is already loaded
            loadSavedScreenData();
            initScreenSelect();
            initButtons();
        }

        // Function to get token from API
        async function getToken() {
            const cif = document.getElementById('cif').value.trim();
            if (!cif) {
                alert('Vui l√≤ng nh·∫≠p m√£ CIF');
                return;
            }

            const privateKeyPem = PRIVATE_KEY;
            const screenDataValue = document.getElementById('screenData').value.trim();
            const getTokenBtn = document.getElementById('getTokenBtn');
            const openSdkBtn = document.getElementById('openSdkBtn');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const resultTitle = document.getElementById('resultTitle');
            const resultContent = document.getElementById('resultContent');

            // Reset
            result.classList.remove('show');
            loading.classList.add('show');
            getTokenBtn.disabled = true;
            openSdkBtn.disabled = true;

            try {
                // 1. Sinh random key 32 bytes (Base64)
                const randomBytes = new Uint8Array(32);
                crypto.getRandomValues(randomBytes);
                const key = btoa(String.fromCharCode(...randomBytes));
                console.log('Random Key:', key);

                // 2. T·∫°o timestamp
                const timestamp = Date.now();
                const message = `${cif}:${timestamp}`;

                console.log('Message to sign:', message);

                // 3. K√Ω RSA SHA256 b·∫±ng jsrsasign
                let signature;
                try {
                    const sig = new KJUR.crypto.Signature({ alg: 'SHA256withRSA' });
                    sig.init(privateKeyPem);
                    sig.updateString(message);
                    signature = hextob64(sig.sign());
                    console.log('Signature:', signature);
                } catch (signError) {
                    throw new Error('L·ªói khi k√Ω: ' + signError.message + '. Ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng Private Key.');
                }

                // 4. T·∫°o payload
                const payload = {
                    CIF: cif,
                    Timestamp: timestamp,
                    Signature: signature
                };

                console.log('Payload:', payload);

                // 5. G·ª≠i request
                const baseUrlInput = document.getElementById('baseUrl');
                const baseUrl = baseUrlInput ? baseUrlInput.value.trim() : "";
                // Thay ƒë·ªïi endpoint ƒë·ªÉ l·∫•y th√¥ng tin token theo t√†i li·ªáu BE 
                const urlGetToken = `${baseUrl}/loyaltySdk/getUrl`;
                // const urlGetToken = 'https://vbb-web-sdk-loyaltyos.akachains.io/loyaltySdk/getUrl';
                const response = await fetch(urlGetToken, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                // Sample data response:
                // {
                //   "domain": "https://vbb-web-sdk-loyaltyos.akachains.io",
                //   "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI5OTg4Nzc2NjYiLCJqdGkiOiIzMDIzOWExMjBhMWE0YmRkOTc3M2E4YTUzZjkzODZkYyIsImNpZiI6Ijk5ODg3NzY2NiIsIm5iZiI6MTc2MzYwMjg1MywiZXhwIjoxNzYzNjAzNDUzLCJpc3MiOiJsb3lhbHR5T1Mtc2RrLWdhdGV3YXkiLCJhdWQiOiJ2aWV0YmFuay1tb2JpbGUtYXBwIn0.FaoB3Q-euf-DJmJalX5Rinu5hiJf23hA4Aoq-Jb1Syw"
                // }
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                if (response.ok) {
                    console.log('data', data);

                    resultTitle.textContent = '‚úÖ Th√†nh c√¥ng';
                    result.className = 'result show success';
                    resultContent.textContent = JSON.stringify(data, null, 2);
                    
                    // L∆∞u to√†n b·ªô response data v√†o SAMPLE_TOKEN d∆∞·ªõi d·∫°ng JSON string
                    localStorage.setItem("SAMPLE_TOKEN", JSON.stringify(data));

                    // Save language to localStorage
                    const languageValue = document.getElementById('languageSelect').value;
                    localStorage.setItem("SAMPLE_LANGUAGE", languageValue);

                    // Save baseUrl to localStorage
                    if (baseUrl) {
                        localStorage.setItem("SAMPLE_BASE_URL", baseUrl);
                    } else {
                        localStorage.removeItem("SAMPLE_BASE_URL");
                    }

                    // Save screen data to localStorage (string format: action/param ho·∫∑c action)
                    if (screenDataValue) {
                        localStorage.setItem("SAMPLE_SCREEN_DATA", screenDataValue);
                    } else {
                        // N·∫øu screen data empty, x√≥a kh·ªèi localStorage ƒë·ªÉ kh√¥ng truy·ªÅn v√†o SDK
                        localStorage.removeItem("SAMPLE_SCREEN_DATA");
                    }
                } else {
                    resultTitle.textContent = '‚ùå L·ªói t·ª´ API';
                    result.className = 'result show error';
                    resultContent.textContent = JSON.stringify(data, null, 2);
                    
                    // L∆∞u to√†n b·ªô error body v√†o SAMPLE_TOKEN d∆∞·ªõi d·∫°ng JSON string
                    localStorage.setItem("SAMPLE_TOKEN", JSON.stringify(data));
                }

            } catch (error) {
                resultTitle.textContent = '‚ùå L·ªói';
                result.className = 'result show error';
                
                // T·∫°o error object v·ªõi to√†n b·ªô th√¥ng tin error
                const errorData = {
                    success: false,
                    error: error.message,
                    message: error.message,
                    stack: error.stack
                };
                resultContent.textContent = JSON.stringify(errorData, null, 2);
                console.error('Error:', error);
                
                // L∆∞u to√†n b·ªô error body v√†o SAMPLE_TOKEN d∆∞·ªõi d·∫°ng JSON string
                localStorage.setItem("SAMPLE_TOKEN", JSON.stringify(errorData));
            } finally {
                loading.classList.remove('show');
                getTokenBtn.disabled = false;
                openSdkBtn.disabled = false;
            }
        }

        // Function to open SDK
        function openSdk() {
            const token = localStorage.getItem('SAMPLE_TOKEN');
            if (!token) {
                alert('Vui l√≤ng l·∫•y token tr∆∞·ªõc khi m·ªü SDK');
                return;
            }

            // Save language before opening SDK
            const languageValue = document.getElementById('languageSelect').value;
            localStorage.setItem("SAMPLE_LANGUAGE", languageValue);

            // Save screen data before opening SDK (string format: action/param ho·∫∑c action)
            const screenDataValue = document.getElementById('screenData').value.trim();
            if (screenDataValue) {
                localStorage.setItem("SAMPLE_SCREEN_DATA", screenDataValue);
            } else {
                // N·∫øu screen data empty, x√≥a kh·ªèi localStorage ƒë·ªÉ kh√¥ng truy·ªÅn v√†o SDK
                localStorage.removeItem("SAMPLE_SCREEN_DATA");
            }

            window.open('/sdk.html', '_self');
        }

        // Initialize button event listeners
        function initButtons() {
            const getTokenBtn = document.getElementById('getTokenBtn');
            const openSdkBtn = document.getElementById('openSdkBtn');

            if (getTokenBtn) {
                getTokenBtn.addEventListener('click', getToken);
            }

            if (openSdkBtn) {
                openSdkBtn.addEventListener('click', openSdk);
            }
        }
    </script>
</body>

</html>